---
import { Icon } from 'astro-icon/components';
---

<!-- 遮罩层 -->
<div
  id="search-overlay"
  data-state="closed"
  class="fixed inset-0 z-40 bg-black/50 opacity-0 backdrop-blur-sm transition-opacity duration-200 data-[state=closed]:hidden"
  role="presentation"
  aria-hidden="true"
>
</div>

<!-- 搜索对话框 -->
<div
  id="search-dialog"
  data-state="closed"
  class="fixed inset-0 z-50 grid place-items-center px-4 data-[state=closed]:hidden"
  role="dialog"
  aria-label="搜索文章"
  aria-modal="true"
>
  <div
    id="search-dialog-content"
    class="bg-gradient-start shadow-box w-full max-w-3xl overflow-auto rounded-xl opacity-0 transition-all duration-200"
  >
    <div class="relative p-6 md:p-3">
      <div class="search-dialog">
        <!-- Header -->
        <div class="relative mb-4 flex items-center justify-between">
          <h2 class="flex items-center gap-2 text-lg font-semibold md:text-base">
            <Icon name="ri:search-line" class="size-5 md:size-4" />
            搜索文章
          </h2>
          <button
            id="search-dialog-close"
            class="flex size-8 items-center justify-center rounded-full bg-black/5 transition-colors duration-300 hover:bg-black/10 md:size-7 dark:bg-white/10 dark:hover:bg-white/20"
            aria-label="关闭搜索"
          >
            <Icon name="ri:close-line" class="size-5 md:size-4" />
          </button>
        </div>
        <div
          id="search-empty-hint"
          class="search-empty-hint absolute inset-x-0 top-32 text-center text-sm opacity-60 md:top-28"
        >
          <p>输入关键词搜索博客文章</p>
          <p class="mt-1 text-xs">
            按 <kbd class="rounded bg-black/10 px-1.5 py-0.5 font-mono dark:bg-white/10">ESC</kbd> 关闭
          </p>
        </div>

        <!-- Search Content Area -->
        <div
          class="vertical-scrollbar scroll-feather-mask -mx-6 h-[calc(80dvh-140px)] overflow-auto scroll-smooth px-6 pb-10 md:-mx-3 md:h-[calc(80dvh-120px)] md:px-3"
        >
          <!-- Search Container -->
          <div id="search-dialog-container"></div>
        </div>
      </div>
      <!-- Keyboard hints -->
      <div
        class="bg-background/2 absolute inset-x-0 bottom-0 z-10 flex items-center justify-center gap-4 px-4 pt-2 pb-4 text-xs text-black/50 dark:border-white/10 dark:text-white/50"
      >
        <span><kbd class="kbd">↑↓</kbd> 选择</span>
        <span><kbd class="kbd">Enter</kbd> 打开</span>
        <span><kbd class="kbd">ESC</kbd> 关闭</span>
      </div>
    </div>
  </div>
</div>

<script>
  import { searchOpen, openSearch, closeSearch } from '@store/ui';

  interface SearchDialogElements {
    overlay: HTMLElement | null;
    dialog: HTMLElement | null;
    content: HTMLElement | null;
    closeBtn: HTMLElement | null;
  }

  const SELECTORS = {
    overlay: 'search-overlay',
    dialog: 'search-dialog',
    content: 'search-dialog-content',
    closeBtn: 'search-dialog-close',
  } as const;

  const CLASSES = {
    opacityFull: 'opacity-100',
    opacityZero: 'opacity-0',
  } as const;

  const STATE = {
    open: 'open',
    closed: 'closed',
  } as const;

  class SearchDialogController {
    private elements: SearchDialogElements;
    private unsubscribe: (() => void) | null = null;
    private selectedIndex: number = -1;
    private resultsObserver: MutationObserver | null = null;

    constructor() {
      this.elements = this.initElements();
      if (this.validateElements()) {
        this.bindEvents();
        this.subscribeToStore();
      }
    }

    private initElements(): SearchDialogElements {
      return Object.entries(SELECTORS).reduce(
        (acc, [key, id]) => ({
          ...acc,
          [key]: document.getElementById(id),
        }),
        {} as SearchDialogElements,
      );
    }

    private validateElements(): boolean {
      return Object.entries(this.elements).every(([key, element]) => {
        const exists = !!element;
        if (!exists) {
          console.error(`搜索对话框元素未找到: ${key}`);
        }
        return exists;
      });
    }

    private bindEvents(): void {
      // Keyboard shortcuts
      document.addEventListener('keydown', this.handleKeyDown);
      // Close button
      this.elements.closeBtn?.addEventListener('click', this.handleClose);
      // Click dialog background (not content) to close
      this.elements.dialog?.addEventListener('click', this.handleBackgroundClick);
    }

    private handleBackgroundClick = (e: MouseEvent): void => {
      // Only close if clicking the dialog background, not the content
      if (e.target === this.elements.dialog) {
        closeSearch();
      }
    };

    private subscribeToStore(): void {
      this.unsubscribe = searchOpen.subscribe((isOpen) => {
        if (isOpen) {
          this.open();
        } else {
          this.close();
        }
      });
    }

    private handleKeyDown = (e: KeyboardEvent): void => {
      // Cmd/Ctrl + K to open
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
        return;
      }

      // Only handle navigation keys when dialog is open
      if (!searchOpen.get()) return;

      // ESC to close
      if (e.key === 'Escape') {
        closeSearch();
        return;
      }

      // Arrow Down: Select next result
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        this.selectResult(this.selectedIndex + 1);
        return;
      }

      // Arrow Up: Select previous result (or back to input)
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        this.selectResult(this.selectedIndex - 1);
        return;
      }

      // Enter: Navigate to selected result
      if (e.key === 'Enter' && this.selectedIndex >= 0) {
        e.preventDefault();
        this.navigateToSelected();
      }
    };

    private handleClose = (): void => {
      closeSearch();
    };

    // Result navigation methods
    private getSelectableItems(): HTMLElement[] {
      const results = Array.from(document.querySelectorAll('.pagefind-ui__result')) as HTMLElement[];
      const loadMoreBtn = document.querySelector('.pagefind-ui__button') as HTMLElement | null;
      // Include load more button if it exists and is visible
      if (loadMoreBtn && loadMoreBtn.offsetParent !== null) {
        return [...results, loadMoreBtn];
      }
      return results;
    }

    private selectResult(index: number): void {
      const items = this.getSelectableItems();
      if (items.length === 0) {
        this.selectedIndex = -1;
        return;
      }

      // Clamp index: -1 (input focused) to items.length - 1
      const newIndex = Math.max(-1, Math.min(index, items.length - 1));

      // Remove old selection
      if (this.selectedIndex >= 0 && this.selectedIndex < items.length) {
        items[this.selectedIndex]?.removeAttribute('data-selected');
      }

      this.selectedIndex = newIndex;

      if (newIndex >= 0) {
        items[newIndex].setAttribute('data-selected', 'true');
        items[newIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      } else {
        // Focus back to input when at -1
        const searchInput = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
        searchInput?.focus();
      }
    }

    private navigateToSelected(): void {
      const items = this.getSelectableItems();
      if (this.selectedIndex < 0 || this.selectedIndex >= items.length) return;

      const selectedItem = items[this.selectedIndex];

      // Check if it's the load more button
      if (selectedItem.classList.contains('pagefind-ui__button')) {
        selectedItem.click();
        // Reset selection after loading more
        this.selectedIndex = -1;
        return;
      }

      // Otherwise it's a result item, navigate to its link
      const link = selectedItem.querySelector('.pagefind-ui__result-link') as HTMLAnchorElement;
      if (link?.href) {
        closeSearch();
        window.location.href = link.href;
      }
    }

    private clearSelection(): void {
      const items = this.getSelectableItems();
      if (this.selectedIndex >= 0 && this.selectedIndex < items.length) {
        items[this.selectedIndex]?.removeAttribute('data-selected');
      }
      this.selectedIndex = -1;
    }

    private setupResultsObserver(): void {
      const container = document.getElementById('search-dialog-container');
      if (!container) return;

      this.resultsObserver = new MutationObserver(() => {
        // Clear selection when results change
        this.clearSelection();
      });

      this.resultsObserver.observe(container, {
        childList: true,
        subtree: true,
      });
    }

    private open(): void {
      const { overlay, dialog, content } = this.elements;
      if (!overlay || !dialog || !content) return;

      // Show elements
      overlay.dataset.state = STATE.open;
      dialog.dataset.state = STATE.open;

      // Lock body scroll
      document.body.style.overflow = 'hidden';

      // Dispatch event for search component portal
      window.dispatchEvent(new CustomEvent('search-dialog-open'));

      // Trigger animation
      requestAnimationFrame(() => {
        overlay.classList.remove(CLASSES.opacityZero);
        overlay.classList.add(CLASSES.opacityFull);
        content.classList.remove(CLASSES.opacityZero);
        content.classList.add(CLASSES.opacityFull);
      });

      // Focus search input after animation
      setTimeout(() => {
        const searchInput = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
        if (searchInput) {
          searchInput.focus();
        }
      }, 150);

      // Setup observer to clear selection when results change
      this.setupResultsObserver();
    }

    private close(): void {
      const { overlay, dialog, content } = this.elements;
      if (!overlay || !dialog || !content) return;

      // Clear selection and disconnect observer
      this.clearSelection();
      this.resultsObserver?.disconnect();
      this.resultsObserver = null;

      // Dispatch event before closing
      window.dispatchEvent(new CustomEvent('search-dialog-close'));

      // Trigger close animation
      overlay.classList.remove(CLASSES.opacityFull);
      overlay.classList.add(CLASSES.opacityZero);
      content.classList.remove(CLASSES.opacityFull);
      content.classList.add(CLASSES.opacityZero);

      // Hide elements after animation
      setTimeout(() => {
        overlay.dataset.state = STATE.closed;
        dialog.dataset.state = STATE.closed;
        document.body.style.overflow = '';
      }, 200);
    }

    public destroy(): void {
      document.removeEventListener('keydown', this.handleKeyDown);
      this.elements.closeBtn?.removeEventListener('click', this.handleClose);
      this.elements.dialog?.removeEventListener('click', this.handleBackgroundClick);

      this.resultsObserver?.disconnect();
      this.resultsObserver = null;

      if (this.unsubscribe) {
        this.unsubscribe();
        this.unsubscribe = null;
      }
    }
  }

  let controller: SearchDialogController | null = null;

  function init() {
    controller?.destroy();
    controller = new SearchDialogController();
  }

  // Initialize immediately if DOM is ready (handles race condition on first load)
  if (document.readyState !== 'loading') {
    init();
  }

  // Also listen for astro:page-load for subsequent navigations
  document.addEventListener('astro:page-load', init);

  // Close before page navigation
  document.addEventListener('astro:before-preparation', () => {
    closeSearch();
  });
</script>

<style is:global>
  /* Hide empty hint when search has results or is loading */
  #search-dialog-container:has(.pagefind-ui__results) ~ #search-empty-hint,
  #search-dialog-container:has(.pagefind-ui__message) ~ #search-empty-hint {
    display: none;
  }

  /* Keyboard hint styles */
  #search-dialog-content .kbd {
    inline-size: fit-content;
    padding-inline: 0.5rem;
    padding-block: 0.25rem;
    border-radius: 0.25rem;
    background-color: rgba(0, 0, 0, 0.1);
    font-family: ui-monospace, SFMono-Regular, monospace;
    font-size: 0.875rem;
    line-height: 1;
    vertical-align: middle;
  }

  .dark #search-dialog-content .kbd {
    background-color: rgba(255, 255, 255, 0.1);
  }
</style>
